#!/usr/bin/env sh

git_version () {
    git describe --tags --exact-match 2>/dev/null || \
        printf %s\\n "git-$(git describe --always --dirty)"
}

if [ "$1" = "build" ]; then
    pkg="$2"
    case "$pkg" in
    micro|fastmod|ripgrep)
        cd "src/${pkg}"
        make
        ;;
    tmux)
        cd src/tmux
        sh autogen.sh
        CFLAGS="-O3 -flto -march=native" ./configure
        make
        ;;
    *)
        echo "packages:"
        ls -1 src
        exit 1
    esac

    v="$(git_version)"
    cd -
    rm -f "${pkg}-"*
    ln -sv "src/${pkg}/${pkg}" "${pkg}-${v}"
    # aliases
    alias="$pkg"
    case "$pkg" in
        ripgrep) alias=rg ;;
    esac
    ln -svf "${pkg}-${v}" "$alias"
fi

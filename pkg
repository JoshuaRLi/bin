#!/usr/bin/env sh

# it would be nice to find out how to or modify packages such that
# i can embed the go/rust/etc. version into their help when building

git_version () {
    printf '%s-%s\n' \
        "$(git describe --tags --abbrev=0)" \
        "$(git log -1 --pretty=format:'%h')"
}

if [ "$1" = "build" ]; then
    shift
    for pkg in "$@"; do
        bins="$pkg"
        case "$pkg" in
        fastmod|fd|srv|direnv|usermount|fzy|vape|tokei)
            cd "src/${pkg}"
            make
            ;;
        micro)
            cd src/micro
            make
            ./micro -plugin install editorconfig
            ;;
        ripgrep)
            cd src/ripgrep
            make
            bins=rg
            ;;
        tmux)
            cd src/tmux
            make -j"$(nproc)" || {
                sh autogen.sh
                CC=gcc CFLAGS="-O2 -flto -pipe -march=native" ./configure
                make clean
                make -j"$(nproc)"
            }
            strip tmux
            ;;
        ncdu)
            cd src/ncdu
            make -j"$(nproc)" || {
                autoreconf -i
                CC=gcc CFLAGS="-O2 -flto -pipe -march=native" ./configure
                make clean
                make -j"$(nproc)"
            }
            strip ncdu
            ;;
        sym-prototype)
            cd src/sym-prototype
            bins=sym
            ;;
        ydiff|pulsemixer)
            cd "src/${pkg}"
            ;;
        ydiff-bin)
            cd src/ydiff
            make
            pkg=ydiff
            ;;
        volta)
            cd src/volta
            RUSTFLAGS="-Ctarget-cpu=native" cargo build --release
            mv target/release/volta volta
            strip volta
            mv target/release/volta-shim volta-shim
            strip volta-shim
            # volta-migrate
            bins='volta volta-shim'
            ;;
        torrent)
            cd src/torrent
            make -j"$(nproc)"
            bins='torrent torrentfs magnet-metainfo'
            ;;
        alacritty)
            cd src/alacritty
            # TODO: macos vs. linux conditionals
            # under linux, would like to build with only wayland feature
            make
            bins=alacritty-bin
            # macos only (needed to launch from spotlight)
            cat <<EOF > "${bin}.command"
#!/bin/sh
"${PWD}/${bin}" &
disown && exit 0
EOF
            chmod u+x "${bin}.command"
            ;;
        *)
            echo "package ${pkg} not found"
            continue
        esac

        v="$(git_version)"
        cd -
        for bin in $bins; do
            rm -f "${bin}-"*
            ln -sv "src/${pkg}/${bin}" "${bin}-${v}"
            ln -svf "${bin}-${v}" "$bin"
        done
    done
fi
